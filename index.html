<!DOCTYPE html>
<html>
  <head>
    <title>ScoBro-Prints</title>
    <link rel="icon" type="image/x-icon" href="asset/scoBroPrints.ico" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="printing.css" />
    <link rel="stylesheet" href="printPreview.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <!-- Update Notification Banner -->
    <div id="updateBanner" class="update-banner hidden">
      <div class="update-content">
        <div class="update-icon">⬇️</div>
        <div class="update-text">
          <strong id="updateTitle">Update Available</strong>
          <p id="updateMessage">A new version is available</p>
          <div id="updateProgress" class="update-progress-bar hidden">
            <div id="updateProgressFill" class="update-progress-fill"></div>
            <span id="updateProgressText" class="update-progress-text">0%</span>
          </div>
        </div>
        <div class="update-actions">
          <button id="updateDownloadBtn" class="update-btn update-btn-primary">Download</button>
          <button id="updateInstallBtn" class="update-btn update-btn-primary hidden">Install & Restart</button>
          <button id="updateLaterBtn" class="update-btn update-btn-secondary">Later</button>
        </div>
      </div>
    </div>

    <div class="app-header">
      <img
        src="asset/scoBroPrints.svg"
        alt="ScoBro Prints Logo"
        class="app-logo"
      />
      <div
        id="app-version"
        style="
          font-size: 12px;
          color: #333;
          margin-top: 4px;
          text-align: center;
        "
      ></div>
      <div>
        <button id="manualUpdateCheck" class="manual-update-check-btn">Check for Updates</button>
      </div>      
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <button id="addPage" class="toolbar-btn">+ Add Page</button>
        <button id="editSize" class="toolbar-btn">Edit Size</button>
        <button id="saveLayout" class="toolbar-btn">Save</button>
        <button id="loadLayout" class="toolbar-btn">Load</button>
        <button id="exportPDF" class="toolbar-btn">Export PDF</button>
        <button id="printPreview" class="toolbar-btn">Print Preview</button>
      </div>
      <div class="toolbar-center">
        <button id="undo" class="toolbar-btn">↶ Undo</button>
        <button id="redo" class="toolbar-btn">↷ Redo</button>
      </div>
      <div class="toolbar-right">
        <button id="resetProject" class="toolbar-btn reset-btn">
          <img
            src="asset/reset.svg"
            alt="Reset"
            style="width: 16px; height: 16px; margin-right: 4px"
          />
          Reset
        </button>
      </div>
    </div>

    <div class="page-navigation">
      <button id="prevPage" class="nav-btn">←</button>
      <span id="pageIndicator">Page 1 of 1</span>
      <button id="nextPage" class="nav-btn">→</button>
    </div>

    <div id="pageContainer">
      <div id="a4Page" class="a4-page">
        <!-- Photo placeholders will be added here dynamically -->
      </div>
    </div>

    <!-- Photo Size Selection Modal -->
    <div id="sizeModal" class="modal">
      <div class="modal-content size-selection-content">
        <div class="modal-header">
          <h2>Select Photo Size</h2>
          <button id="closeSizeModal" class="close-btn">&times;</button>
        </div>
        <div class="size-categories">
          <h3>Small Sizes (Wallet/Compact)</h3>
          <div class="size-options">
            <button data-size="51x51">51×51mm Square</button>
            <button data-size="64x89-p">64×89mm Portrait</button>
            <button data-size="89x64-l">89×64mm Landscape</button>
            <button data-size="89x127-p">89×127mm Portrait</button>
            <button data-size="127x89-l">127×89mm Landscape</button>
          </div>

          <h3>Common Sizes</h3>
          <div class="size-options">
            <button data-size="102x152-p">102×152mm Portrait</button>
            <button data-size="152x102-l">152×102mm Landscape</button>
            <button data-size="127x178-p">127×178mm Portrait</button>
            <button data-size="178x127-l">178×127mm Landscape</button>
            <button data-size="152x203-p">152×203mm Portrait</button>
            <button data-size="203x152-l">203×152mm Landscape</button>
          </div>

          <h3>Large Sizes</h3>
          <div class="size-options">
            <button data-size="203x254-p">203×254mm Portrait</button>
            <button data-size="254x203-l">254×203mm Landscape</button>
          </div>

          <div class="custom-size-header">
            <h3>
              <input type="checkbox" id="enableCustomSize" />
              Custom Size
            </h3>
          </div>
          <div class="custom-size-section" id="customSizeSection">
            <div class="custom-size-inputs">
              <div class="input-group">
                <label>Width (mm)</label>
                <input type="number" id="customWidth" value="100" disabled />
                <div class="validation-message" id="widthValidation">
                  Width must be between 1 and 210mm
                </div>
              </div>
              <div class="input-group">
                <label>Height (mm)</label>
                <input type="number" id="customHeight" value="150" disabled />
                <div class="validation-message" id="heightValidation">
                  Height must be between 1 and 297mm
                </div>
              </div>
            </div>
            <div class="size-modal-actions">
              <button id="applyCustomSize" class="apply-size-btn" disabled>
                Apply Custom Size
              </button>
            </div>
          </div>
        </div>
        <div class="size-modal-footer">
          <button id="applyToPage" class="apply-to-page-btn" disabled>
            Apply To Page
          </button>
        </div>
      </div>
    </div>

    <!-- Image Editor Modal -->
    <div id="imageEditorModal" class="modal">
      <div class="modal-content">
        <h2>Edit Image</h2>
        <div id="imageEditorPreview" class="image-container"></div>
        <div class="image-controls">
          <div class="slider-control">
            <label>Zoom (<span id="zoomValue">100</span>%)</label>
            <div class="slider-with-reset">
              <input
                type="range"
                id="imageZoom"
                min="50"
                max="500"
                value="100"
              />
              <button id="resetZoom" class="reset-slider-btn">Reset</button>
            </div>
          </div>
          <div class="slider-control">
            <label>Rotation (<span id="rotationValue">0</span>°)</label>
            <div class="slider-with-reset">
              <input
                type="range"
                id="imageRotation"
                min="0"
                max="360"
                value="0"
              />
              <button id="resetRotation" class="reset-slider-btn">Reset</button>
            </div>
          </div>
          <div class="image-editor-controls">
            <button id="fitImage">Fit to Card</button>
            <button id="fillImage">Fill Card</button>
            <button id="rotateLeft">Rotate Left</button>
            <button id="rotateRight">Rotate Right</button>
          </div>
          <div class="editor-actions">
            <div>
              <button id="undoEdit">↶ Undo</button>
              <button id="redoEdit">↷ Redo</button>
            </div>
            <div>
              <button id="cancelChanges">Cancel</button>
              <button id="applyChanges">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="printPreviewModal" class="modal">
      <div class="modal-content">
        <h2>Print Preview</h2>
        <div id="printPreviewContent"></div>
        <button id="confirmPrint">Print</button>
        <button id="cancelPrint">Cancel</button>
      </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="printPreviewModal" class="modal">
      <div class="modal-content">
        <h2>Print Preview</h2>
        <div id="printPreviewContent"></div>
        <button id="confirmPrint">Print</button>
        <button id="cancelPrint">Cancel</button>
      </div>
    </div>

    <script src="node_modules/html2canvas/dist/html2canvas.min.js"></script>
    <script src="node_modules/jspdf/dist/jspdf.umd.min.js"></script>
    <script src="command.js"></script>
    <script type="module" src="layoutRenderer.js"></script>
    <script type="module" src="renderer.js"></script>
    <script src="printPreview.js"></script>
    <script src="printing.js"></script>
    
    <!-- Update Handler Script -->
    <script>
      // Update UI Controller
      (function() {
        const updateBanner = document.getElementById('updateBanner');
        const updateTitle = document.getElementById('updateTitle');
        const updateMessage = document.getElementById('updateMessage');
        const updateProgress = document.getElementById('updateProgress');
        const updateProgressFill = document.getElementById('updateProgressFill');
        const updateProgressText = document.getElementById('updateProgressText');
        const downloadBtn = document.getElementById('updateDownloadBtn');
        const installBtn = document.getElementById('updateInstallBtn');
        const laterBtn = document.getElementById('updateLaterBtn');
        
        let currentUpdateInfo = null;
        
        // Initialize button states
        function setDownloadState() {
          downloadBtn.classList.remove('hidden');
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download';
          installBtn.classList.remove('hidden');
          installBtn.disabled = true;
        }
        
        function setReadyToInstallState() {
          downloadBtn.classList.remove('hidden');
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download';
          installBtn.classList.remove('hidden');
          installBtn.disabled = false;
        }
        
        // Show banner
        function showBanner() {
          updateBanner.classList.remove('hidden');
          // Adjust page container to account for banner height
          document.getElementById('pageContainer').style.marginTop = '60px';
        }
        
        // Hide banner
        function hideBanner() {
          updateBanner.classList.add('hidden');
          document.getElementById('pageContainer').style.marginTop = '0';
        }
        
        // Update checking
        window.electron.onUpdateChecking(() => {
          console.log('Checking for updates...');
        });
        
        // Update available
        window.electron.onUpdateAvailable((info) => {
          console.log('Update available:', info);
          currentUpdateInfo = info;
          updateTitle.textContent = `Version ${info.version} Available`;
          updateMessage.textContent = 'A new version is ready to download';
          setDownloadState();
          updateProgress.classList.add('hidden');
          showBanner();
          // Dispatch event to restore manual check button
          window.dispatchEvent(new CustomEvent('update-available'));
        });
        
        // Update not available
        window.electron.onUpdateNotAvailable((info) => {
          console.log('No updates available');
          // Don't show banner if no update
          // Dispatch event to trigger success state on manual check button
          window.dispatchEvent(new CustomEvent('update-not-available'));
        });
        
        // Update error
        window.electron.onUpdateError((error) => {
          console.error('Update error:', error);
          updateTitle.textContent = 'Update Error';
          updateMessage.textContent = error.message || 'Failed to check for updates';
          updateProgress.classList.add('hidden');
          // Reset button states on error
          downloadBtn.classList.remove('hidden');
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download';
          installBtn.classList.remove('hidden');
          installBtn.disabled = true;
          showBanner();
          // Auto-hide after 5 seconds
          setTimeout(hideBanner, 5000);
        });
        
        // Download progress
        window.electron.onUpdateDownloadProgress((progress) => {
          const percent = Math.round(progress.percent);
          updateProgress.classList.remove('hidden');
          updateProgressFill.style.width = `${percent}%`;
          updateProgressText.textContent = `${percent}%`;
          updateMessage.textContent = `Downloading update... (${formatBytes(progress.bytesPerSecond)}/s)`;
          // Keep both buttons visible but disabled during download
          downloadBtn.classList.remove('hidden');
          downloadBtn.disabled = true;
          downloadBtn.textContent = 'Downloading...';
          installBtn.classList.remove('hidden');
          installBtn.disabled = true;
        });
        
        // Update downloaded
        window.electron.onUpdateDownloaded((info) => {
          console.log('Update downloaded:', info);
          currentUpdateInfo = info;
          updateTitle.textContent = 'Update Ready';
          updateMessage.textContent = `Version ${info.version} is ready to install`;
          updateProgress.classList.add('hidden');
          setReadyToInstallState();
        });
        
        // Update dismissed
        window.electron.onUpdateDismissed(() => {
          hideBanner();
        });
        
        // Button handlers
        downloadBtn.addEventListener('click', () => {
          console.log('Download button clicked');
          if (!downloadBtn.disabled) {
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';
            window.electron.downloadUpdate();
          }
        });
        
        installBtn.addEventListener('click', () => {
          console.log('Install button clicked');
          if (!installBtn.disabled) {
            installBtn.disabled = true;
            installBtn.textContent = 'Installing...';
            window.electron.installUpdate();
          }
        });
        
        laterBtn.addEventListener('click', () => {
          console.log('Remind later clicked');
          window.electron.remindLater();
        });
        
        // Helper function
        function formatBytes(bytes) {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return `${Math.round(bytes / Math.pow(k, i) * 100) / 100} ${sizes[i]}`;
        }
        
        // Check on startup if update is already downloaded
        (async () => {
          try {
            const downloadState = await window.electron.isUpdateDownloaded();
            if (downloadState.isDownloaded && downloadState.updateInfo) {
              // Update already downloaded, show install button
              currentUpdateInfo = downloadState.updateInfo;
              updateTitle.textContent = 'Update Ready';
              updateMessage.textContent = `Version ${downloadState.updateInfo.version} is ready to install`;
              setReadyToInstallState();
              updateProgress.classList.add('hidden');
              showBanner();
            }
          } catch (error) {
            console.error('Failed to check download state:', error);
          }
        })();
      })();
    </script>
  </body>
</html>
